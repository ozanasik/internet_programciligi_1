document.addEventListener("DOMContentLoaded", () => {
    let cart = JSON.parse(localStorage.getItem("cart")) || []; 
    let tasks = JSON.parse(localStorage.getItem("tasks")) || []; 

    const cartCount = document.getElementById("cartCount");
    const cartList = document.getElementById("cartList");
    const totalPriceEl = document.getElementById("totalPrice");
    const emptyCartMsg = document.getElementById("emptyCartMsg");
    const searchInput = document.getElementById("searchInput");
    
    // Verileri yÃ¼kle
    updateCartDisplay();
    loadTasks();

    // 1. SEPETE EKLEME
    document.querySelectorAll(".add-cart").forEach(btn => {
        btn.addEventListener("click", function() {
            const name = this.getAttribute("data-name");
            const price = parseInt(this.getAttribute("data-price"));

            cart.push({ name: name, price: price });
            saveCart();
            updateCartDisplay();
            showToast("ÃœrÃ¼n sepete eklendi! ðŸš€");
        });
    });

    // 2. SEPETÄ° GÃœNCELLEME
    function updateCartDisplay() {
        cartCount.innerText = cart.length;
        cartList.innerHTML = "";
        let total = 0;

        if(cart.length === 0) {
            emptyCartMsg.classList.remove("d-none");
        } else {
            emptyCartMsg.classList.add("d-none");
        }

        cart.forEach((item, index) => {
            total += item.price;
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `
                <div>
                    <span class="fw-bold">${item.name}</span>
                    <br><small class="text-muted">${formatMoney(item.price)}</small>
                </div>
                <button class="btn btn-sm btn-outline-danger delete-item" data-index="${index}">
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;
            cartList.appendChild(li);
        });

        totalPriceEl.innerText = formatMoney(total);

        document.querySelectorAll(".delete-item").forEach(btn => {
            btn.addEventListener("click", function() {
                const index = this.getAttribute("data-index");
                cart.splice(index, 1);
                saveCart();
                updateCartDisplay();
            });
        });
    }

    // 3. SATIN AL BUTONU
    document.getElementById("buyBtn").addEventListener("click", () => {
        if(cart.length === 0) return alert("Sepetiniz boÅŸ!");
        
        alert(`Toplam ${totalPriceEl.innerText} â‚º ðŸ’° tutarÄ±ndaki sipariÅŸiniz alÄ±ndÄ± ðŸŽ‰! ðŸ˜Ž Bizi tercih ettiÄŸiniz iÃ§in teÅŸekkÃ¼rlerðŸ’».`);
        cart = [];
        saveCart();
        updateCartDisplay();
        
        // ModalÄ± kapat (Bootstrap 5)
        const modalEl = document.getElementById('cartModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    });

    // 4. BAÄžIÅž YAP BUTONU (DÃ¼zeltildi)
    document.getElementById("donateBtn").addEventListener("click", () => {
        if(cart.length === 0) return alert("Sepetiniz boÅŸ, baÄŸÄ±ÅŸlanacak Ã¼rÃ¼n yok!");

        alert("BaÄŸÄ±ÅŸÄ±nÄ±z iÃ§in teÅŸekkÃ¼r ederiz ðŸŽ. Bilgisayarlar ihtiyacÄ± olan okullara ulaÅŸtÄ±rÄ±lacaktÄ±r ðŸŽ“.");
        cart = [];
        saveCart();
        updateCartDisplay();
        
        // ModalÄ± kapat
        const modalEl = document.getElementById('cartModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    });

    // 5. ARAMA (SEARCH)
    searchInput.addEventListener("keyup", (e) => {
        const term = e.target.value.toLowerCase();
        const cards = document.querySelectorAll(".product-card");

        cards.forEach(card => {
            const productName = card.querySelector(".card-title").innerText.toLowerCase();
            if(productName.includes(term)) {
                card.style.display = "block";
            } else {
                card.style.display = "none";
            }
        });
    });

    // 6. ALINACAKLAR LÄ°STESÄ°
    document.getElementById("taskAdd").addEventListener("click", addTask);
    
    function addTask() {
        const input = document.getElementById("taskInput");
        if (!input.value) return;

        tasks.push(input.value);
        localStorage.setItem("tasks", JSON.stringify(tasks));
        loadTasks();
        input.value = "";
    }

    function loadTasks() {
        const list = document.getElementById("taskList");
        list.innerHTML = "";
        
        tasks.forEach((task, index) => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center mt-2 border rounded";
            li.innerHTML = `
                ${task} 
                <button class="btn btn-sm btn-danger delete-task" onclick="removeTask(${index})">
                    <i class="fa-solid fa-xmark"></i>
                </button>`;
            list.appendChild(li);
        });
    }

    window.removeTask = function(index) {
        tasks.splice(index, 1);
        localStorage.setItem("tasks", JSON.stringify(tasks));
        loadTasks();
    };

    // YARDIMCI FONKSÄ°YONLAR
    function saveCart() {
        localStorage.setItem("cart", JSON.stringify(cart));
    }

    function formatMoney(amount) {
        return amount.toLocaleString('tr-TR');
    }

    function showToast(message) {
        const toastEl = document.getElementById('liveToast');
        const toastBody = toastEl.querySelector('.toast-body');
        toastBody.innerText = message;
        // EÄŸer Ã¶nceki toast aÃ§Ä±ksa resetle
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
});
